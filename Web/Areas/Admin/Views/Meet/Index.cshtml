
@{
    ViewBag.Title = "会议管理";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="am-cf am-padding">
    <div class="am-fl am-cf"><a href="/"><strong class="am-text-primary am-text-lg">首页</strong></a> /<small>会议管理</small></div>
</div>
<div id="searchDomain">

    <div class="am-g">
        <div class="am-u-lg-12">
            <div class="am-input-group am-input-group-sm">
                <span class="am-input-group-label">会议名称</span>
                <input type="text" class="am-form-field" placeholder="按会议名称搜索" name="title" ;>
                <span class="am-input-group-label  am-margin-left-sm">活动日期</span>
                <input type="text" class="am-form-field" placeholder="请选择日期" name="createdTimeStart" readonly style="width:auto;">
                <span class="am-input-group-label"> - </span>
                <input type="text" class="am-form-field" placeholder="请选择日期" name="createdTimeEnd" readonly style="width:auto;">
                <span class="am-input-group-btn am-margin-left-sm">
                    <button class="am-btn am-btn-default" id="btnSearch" type="button">搜索</button>
                    <button class="am-btn am-btn-default" onclick="ClearFilter()" type="button">清除</button>
                </span>
            </div>
        </div>
    </div>
    <div class="am-g am-margin-top-sm">
        <div class="am-u-lg-4">
            <div class="am-btn-toolbar">
                <div class="am-btn-group am-btn-group-sm">
                    <button onclick="add()" type="button" class="am-btn am-btn-default"><span class="am-icon-plus"></span> 新增</button>
                    <button onclick="batchDelete()" type="button" class="am-btn am-btn-default"><span class="am-icon-trash-o"></span> 删除</button>
                </div>
            </div>
        </div>

    </div>
</div>
<div class="grid_container">
    <table id="dataTable" class="am-table am-table-striped am-table-hover table-main">
        <thead>
            <tr>
                <th dataname="ID" type="checkbox"></th>
                <th dataname="Name">会议名称</th>
                <th dataname="Address">地点</th>
                <th dataname="IsJoinAuditStr">需要审核</th>
                <th dataname="IsChangeQrcodeStr">动态签到</th>
                <th dataname="MaxLimit">人数限制</th>
                <th dataname="OngoingTime" datatype="jsondate">开始时间</th>
                <th dataname="OverTime" datatype="jsondate">结束时间</th>
                <th type="eventlist"></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
@section scripts
{
    <script src="~/Scripts/UEditor/ueditor.config.js"></script>
    <script src="~/Scripts/UEditor/ueditor.all.js"></script>
    <script src="~/Scripts/UEditor/ueditor.parse.js"></script>
    <script src="~/Scripts/UEditor/lang/zh-cn/zh-cn.js"></script>
    <script type="text/javascript">
        $('[name=createdTimeStart]').datepicker({ format: 'yyyy-mm-dd' });
        $('[name=createdTimeEnd]').datepicker({ format: 'yyyy-mm-dd' });


        function ClearSpeakerFilter() {
            $("#searchSpeakerDomain input").val("");
        }
        function ClearFilter() {
            $("#searchDomain input").val("");
        }
        var ue;
        function formInit(dataitem) {
            var txtContentId = $.AMUI.utils.generateGUID("txtContent");
            $(".txtContent").attr("id", txtContentId)
            ue = UE.getEditor(txtContentId);
            if (dataitem != null) {
                GetTemplete(dataitem.Rooms);
                if (dataitem.Meet.PlaceImage != null) {
                    $("#div_meetImageShow").find("img").attr("src", dataitem.Meet.PlaceImage);
                }
                if (dataitem.Meet.DownLoadInfos != null&&dataitem.Meet.DownLoadInfos != "") {
                    var fileJson = JSON.parse(dataitem.Meet.DownLoadInfos);
                    $(fileJson).each(function (index, item) {
                        $("#infoFileDiv").append('<div class="am-g am-margin-top"><div class="am-u-md-12 am-text-left"><span>' + item.Name + '</span><a onclick="javascript:$(this).parent().parent().remove();" style="position:static;" class="am-close am-close-alt am-icon-times" data-path="' + item.Path + '"  data-Name="' + item.Name + '"></a></div></div>');
                    })
                }

                if (dataitem.Meet.Content != null) {
                    ue.addListener("ready", function () {
                        // editor准备好之后才可以使用
                        ue.setContent(dataitem.Meet.Content);
                    });
                }
            }

            //添加表单验证
            $.Nuoya.form("form").validate({
                rules: {
                    Name: {
                        required: true,
                        maxlength: 64
                    },
                    Address: {
                        required: true,
                        maxlength: 512
                    },
                    RoomIDs: {
                        required: true
                    },

                    OngoingTime: {
                        required: true
                    },
                    OverTime: {
                        required: true
                    }
                },
                messages: {
                    Name: {
                        required: "不允许为空",
                        maxlength: "最多{0}个字符"
                    },
                    Address: {
                        required: "不允许为空",
                        maxlength: "最多{0}个字符"
                    },
                    RoomIDs: {
                        required: "不允许为空"
                    },
                    OngoingTime: {
                        required: "不允许为空"
                    },
                    OverTime: {
                        required: "不允许为空"
                    }
                }
            });

            UploadImg();

            $("[name='RoomIDsSelect']").ztreeSelect($("[name='RoomIDs']"), "/Admin/Room/GetZTreeChildren",  "", true, false);
        }

        function DeleteTopic(obj)
        {
            if ($(obj).parents(".meetplan").find(".meetTopic").length == 1)
            {
                $(obj).parents(".meetplan").find(".topicTitle").hide();
            }
            $(obj).parent().parent().remove();
        }

        function AddTopic(obj)
        {
            $(AddTopicHtml()).insertBefore($(obj).parent());
            $(obj).parents(".meetplan").find(".topicTitle").show();
            event.preventDefault();
        }

        //计划模板
        function GetTemplete(roomAry) {
            $("#roomDiv").html("");
            $(roomAry).each(function (index, item) {

                //坊间
                var rommsTemplete = '<div class="am-g am-margin-top am-panel am-panel-default roomPlans" >' +
                                        '<div class="am-g">' +
                                            '<strong class="am-text-primary am-text-lg">' + item.Name + '</strong>' +
                                        '</div>' +
                                        '<div class="am-u-md-12">' +
                                            '<div class="am-g am-margin-top">' +
                                                '<div class="am-u-md-1 am-text-center">' +
                                                    '序号 ' +
                                                '</div>' +
                                                '<div class="am-u-md-2 am-text-center">' +
                                                    '开始时间' +
                                                '</div>' +

                                                '<div class="am-u-md-5 am-text-center">' +
                                                    '演讲主题' +
                                                '</div>' +
                                                '<div class="am-u-md-2 am-text-center">' +
                                                    '演讲人' +
                                                '</div>' +
                                                '<div class="am-u-md-1 am-text-center am-u-end">' +
                                                    '操作' +
                                                '</div>' +
                                            '</div>' +
                                        '</div>';
                //主题
                if (item.MeetPlans && item.MeetPlans.length > 0) {
                    $(item.MeetPlans).each(function (y, obj) {
                        rommsTemplete +=
                                        '<div class="am-u-md-12 meetplan" data-roomId="' + item.ID + '" data-planId="' + obj.ID + '">' +
                                            '<div class="am-g am-margin-top">' +
                                                '<div class="am-u-md-1 am-text-center">' +
                                                    '' + (y+1) + '' +
                                                '</div>' +
                                                '<div class="am-u-md-2 am-text-center">' +
                                                    "<input type=\"text\" name=\"PlanStartTime\" value='" + RenderTime(obj.StratTime) + "' style=\"width:254px;float:left;\" readonly onfocus=\"WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss',minDate:'#F{$dp.$D(\\'d4311\\')}',maxDate:'#F{$dp.$D(\\'d4312\\')}'})\" datatype=\"jsondate\" />" +
                                                '</div>' +
                                                '<div class="am-u-md-5 am-text-center">' +
                                                    '<input type="text" name="PlanName" value="' + obj.Name + '" class="am-input-sm" maxlength="64">' +
                                                '</div>' +
                                                '<div class="am-u-md-2 am-text-center">' +
                                                    '<input type="hidden" name="PlanSpeakerID" readonly value="' + obj.SpeakerID + '"/>' +
                                                    '<label for="user-name" class="am-form-label am-margin-right">' + (obj.SpeakerName!=null?obj.SpeakerName:"") + '</label>' +
                                                    '<button class="am-btn am-btn-success am-btn-xs" onclick="SelectSpeaker(this)">选择</button>' +
                                                '</div>' +
                                                '<div class="am-u-md-1 am-text-center am-u-end">' +
                                                    '<button class="am-btn am-btn-danger am-btn-xs" onclick="javascript:$(this).parents(\'.meetplan\').remove();">删除</button>' +
                                                '</div>' +
                                           '</div>' +
                                            '<div class="am-g am-margin-top topicTitle">' +
                                                '<div class="am-u-md-2 am-text-center">' +
                                                      ' &nbsp;' +
                                                 '</div>' +
                                                 '<div class="am-u-md-1 am-text-center">' +
                                                     '序号 ' +
                                                 '</div>' +
                                                 '<div class="am-u-md-5 am-text-center">' +
                                                     '话题' +
                                                 '</div>' +
                                                 '<div class="am-u-md-2 am-text-center am-u-end">' +
                                                     '&nbsp;' +
                                                 '</div>' +
                                            '</div>';
                        if (obj.MeetTopics && obj.MeetTopics.length > 0) {
                            $(obj.MeetTopics).each(function (z, temp) {
                                rommsTemplete +=
                                            '<div class="am-g am-margin-top meetTopic" data-topicId="'+temp.ID+'">' +
                                                '<div class="am-u-md-2 am-text-center">' +
                                                    '&nbsp;' +
                                                '</div>' +
                                                '<div class="am-u-md-1 am-text-center">' +
                                                    '' + (z + 1) + '' +
                                                '</div>' +
                                                '<div class="am-u-md-5 am-text-center">' +
                                                    '<input type="text" name="TopicName" value="' + temp.Name + '" class="am-input-sm" maxlength="64">' +
                                                '</div>' +
                                                '<div class="am-u-md-2 am-text-center am-u-end">' +
                                                    '<button class="am-btn am-btn-danger am-btn-xs" onclick="DeleteTopic(this)">删除</button>' +
                                                '</div>' +
                                            '</div>';
                            });
                            rommsTemplete +=
                                             '<div class="am-g am-margin-top">' +
                                                '<button class="am-btn am-btn-primary am-btn-xs" onclick="AddTopic(this)">新增话题</button>' +
                                            '</div>';
                        }
                        else {
                            rommsTemplete += AddTopicHtml();
                        }
                        rommsTemplete += '</div>';
                    });
                }
                else {
                    rommsTemplete += GetAppendHtml(item.ID);
                }


                rommsTemplete +=
                '<div class="am-u-md-12">' +
                    '<div class="am-g am-margin-top am-margin-bottom">' +
                        '<button type="button" class="am-btn am-btn-success" onclick="javascript:$(GetAppendHtml(\'' + item.ID + '\')).insertBefore($(this).parent().parent())">新增会议计划</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
                $("#roomDiv").append(rommsTemplete);
            });
        }
        //按钮加载计划等
        function LoadPlan(obj) {

            if (!document.forms[0].RoomIDs.value) {
                $.Nuoya.alert("请选择会议厅");
                return false;
            }

            GetTemplete(valueTextAry);
            $(obj).hide();
        };
        //添加的计划
        function GetAppendHtml(roomId) {
            return '<div class="am-u-md-12 meetplan" data-roomId="' + roomId + '" >' +
                        '<div class="am-g am-margin-top">' +
                            '<div class="am-u-md-1 am-text-center">' +
                                '+' +
                            '</div>' +
                            '<div class="am-u-md-2 am-text-center">' +
                                "<input type=\"text\" name=\"PlanStartTime\"  style=\"width:254px;float:left;\" readonly onfocus=\"WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss',minDate:'#F{$dp.$D(\\'d4311\\')}',maxDate:'#F{$dp.$D(\\'d4312\\')}'})\" datatype=\"jsondate\" />" +
                            '</div>' +
                            '<div class="am-u-md-5 am-text-center">' +
                                '<input type="text" name="PlanName" class="am-input-sm" maxlength="64">' +
                            '</div>' +
                            '<div class="am-u-md-2 am-text-center">' +
                               '<input type="hidden" name="PlanSpeakerID" readonly value=""/>' +
                               '<label for="user-name" class="am-form-label am-margin-right"></label>' +
                               '<button class="am-btn am-btn-success am-btn-xs" onclick="SelectSpeaker(this)">选择</button>' +
                            '</div>' +
                            '<div class="am-u-md-1 am-text-center am-u-end">' +
                                '<button class="am-btn am-btn-danger am-btn-xs"  onclick="javascript: $(this).parent().parent().remove();">删除</button>' +
                            '</div>' +
                        '</div>' +
                        '<div class="am-g am-margin-top topicTitle">' +
                              '<div class="am-u-md-2 am-text-center">&nbsp;' +
                               '</div>' +
                               '<div class="am-u-md-1 am-text-center">' +
                                    '话题序号 ' +
                               '</div>' +
                               '<div class="am-u-md-5 am-text-center">' +
                                    '话题名称' +
                                '</div>' +
                                '<div class="am-u-md-2 am-text-center am-u-end">' +
                                     '操作' +
                                '</div>' +
                        '</div>' +
                        '<div class="am-g am-margin-top meetTopic">' +
                           '<div class="am-u-md-2 am-text-center">&nbsp;' +
                           '</div>' +
                           '<div class="am-u-md-1 am-text-center">' +
                                   '+' +
                           '</div>' +
                           '<div class="am-u-md-5 am-text-center">' +
                                 '<input type="text" name="TopicName" value="" class="am-input-sm" maxlength="64">' +
                            '</div>' +
                            '<div class="am-u-md-2 am-text-center am-u-end">' +
                                 '<button class="am-btn am-btn-danger am-btn-xs" onclick="DeleteTopic(this)">删除</button>' +
                            '</div>' +
                       '</div>' +
                        '<div class="am-g am-margin-top">' +
                            '<button class="am-btn am-btn-primary am-btn-xs" onclick="AddTopic(this)">新增话题</button>' +
                        '</div>' +
                '</div>';
        }
        //添加话题
        function AddTopicHtml() {
            return '<div class="am-g am-margin-top meetTopic">' +
                '<div class="am-u-md-2 am-text-center">' +
                    '&nbsp;' +
                '</div>' +
                '<div class="am-u-md-1 am-text-center">' +
                    '+' +
                '</div>' +
                '<div class="am-u-md-5 am-text-center">' +
                    '<input type="text" name="TopicName"  class="am-input-sm" maxlength="64">' +
                '</div>' +
                '<div class="am-u-md-2 am-text-center am-u-end">' +
                    '<button class="am-btn am-btn-danger am-btn-xs" onclick="DeleteTopic(this)">删除</button>' +
                '</div>' +
            '</div>';
        }


        function speakerFormInit(dataitem) {
            //添加表单验证
            $.Nuoya.form("speakerForm").validate({
                rules: {
                    Name: {
                        required: true,
                        maxlength: 50
                    },
                    ShortKey: {
                        required: true,
                        maxlength: 512
                    },
                    Position: {
                        maxlength: 32
                    },
                    Phone: {
                        mobile: true
                    }
                },
                messages: {
                    Name: {
                        required: "不允许为空",
                        maxlength: "最多{0}个字符"
                    },
                    ShortKey: {
                        required: "不允许为空",
                        maxlength: "最多{0}个字符"
                    },
                    Position: {
                        maxlength: "最多{0}个字符"
                    }
                }
            });

            var headImagebtn = $("#headImageFile").uploadFile({
                url: '/upload/uploadimage?mark=user',
                fileSuffixs: ["jpg", "png", 'jpeg'],
                maximumFilesUpload: 1,//最大文件上传数       ]
                isGetFileSize: true,
                maxFileSize: 200 * 1024 * 1024,
                onComplete: function (data) {
                    debugger
                    if (data) {
                        $("[name='HeadImages']").val(data);
                        $("#div_headImageShow").show().find("img").attr("src", data);
                    }
                    else {
                        $.Nuoya.alert("上传错误");
                    }

                },
                onChosen: function (file, obj, fileSize, errorText) {
                    if (errorText) {
                        $.Nuoya.alert(errorText);
                        return false;
                    }
                    //Loading("图片正在上传中...", "请稍等");
                    uploadheadimage.submitUpload();
                    return true;//返回false将取消当前选择的文件
                },
            });
            var uploadheadimage = headImagebtn.data("uploadFileData");
        }
        //添加演讲者
        function addSpeaker() {
            $.Nuoya.ajaxDialog({
                closeViaDimmer: false,
                ajaxUrl: "/Areas/Admin/HtmlTemplates/Speaker/Update.html",
                title: "添加演讲者",
                callback: function (e) {
                    speakerFormInit();//表单初始化
                },
                buttons: [{
                    label: "保存",
                    callback: function (e) {
                        $.Nuoya.form("speakerForm").ajaxSubmit({
                            ajaxUrl: "/Admin/Speaker/Add",
                            callback: function (data) {
                                if (data.Result) {
                                    speakerGrid.reload();
                                    e.hide();
                                }
                                else
                                    $.Nuoya.alert(data.Result);
                            }
                        });
                    }
                }]
            })
        }
        //演讲者弹窗
        var speakerGrid;
        function SelectSpeaker(obj) {
            $.Nuoya.ajaxDialog({
                closeViaDimmer: false,
                width: "1200px",
                height: "800px",
                ajaxUrl: "/Areas/Admin/HtmlTemplates/Speaker/Index.html",
                title: "选择演讲者",
                callback: function (e) {
                    speakerGrid = $.Nuoya.grid({
                        tableId: "speakerDataTable",
                        //表格id
                        search: {
                            domainId: "searchSpeakerDomain",
                            subId: "btnSpeakerSearch"
                        },
                        ajaxUrl: "/Admin/Speaker/GetPageList",
                        //数据请求地址
                        pageSize: 10,
                        events: [
                            {
                                className: "am-text-secondary",
                                icon: "icon-pencil-square-o",
                                name: "选择",
                                click: function (item) {
                                    $(obj).prev().html(item.Name);
                                    $(obj).prev().prev().val(item.ID);
                                    e.hide();
                                }
                            }
                        ]
                    });
                }
            });
            event.preventDefault();
        }

        function UploadImg() {
            var headimgbtn = $("#imageFile").uploadFile({
                url: '/upload/uploadimage?mark=meet',
                fileSuffixs: ["jpg", "png", 'jpeg'],
                maximumFilesUpload: 1,//最大文件上传数       ]
                isGetFileSize: true,
                maxFileSize: 200 * 1024 * 1024,
                onComplete: function (data) {
                    if (data) {
                        $("[name='PlaceImage']").val(data);
                        $("#div_meetImageShow").show().find("img").attr("src", data);
                    }
                    else {
                        $.Nuoya.alert("上传错误");
                    }

                },
                onChosen: function (file, obj, fileSize, errorText) {
                    if (errorText) {
                        $.Nuoya.alert(errorText);
                        return false;
                    }
                    //Loading("图片正在上传中...", "请稍等");
                    uploadheadimg.submitUpload();
                    return true;//返回false将取消当前选择的文件
                },
            });
            var uploadheadimg = headimgbtn.data("uploadFileData");

            var infoFilebtn = $("#infoFile").uploadFile({
                url: '/upload/UploadFile?mark=file',
                maximumFilesUpload: 5,//最大文件上传数
                isGetFileSize: true,
                isCheckFileSuffixs: false,
                maxFileSize: 200 * 1024 * 1024,
                onComplete: function (json) {
                    var data = jQuery.parseJSON(json);
                    if (data.Path != "") {
                        $("#infoFileDiv").append('<div class="am-g am-margin-top"><div class="am-u-md-12 am-text-left"><span>' + data.Name + '</span><a onclick="javascript:$(this).parent().parent().remove();" style="position:static;" class="am-close am-close-alt am-icon-times" data-path="' + data.Path + '"  data-Name="' + data.Name + '"></a></div></div>');
                    }
                    else {
                        $.Nuoya.alert("上传错误");
                    }

                },
                onChosen: function (file, obj, fileSize, errorText) {
                    if (errorText) {
                        $.Nuoya.alert(errorText);
                        return false;
                    }
                    //Loading("图片正在上传中...", "请稍等");
                    uploadInfoFile.submitUpload();
                    return true;//返回false将取消当前选择的文件
                },
            });
            var uploadInfoFile = infoFilebtn.data("uploadFileData");
        }
        //新增
        function add() {
            $.Nuoya.ajaxDialog({
                closeViaDimmer: false,
                width: ($(window).width() - 100) + "px",
                height: ($(window).height() - 100) + "px",
                ajaxUrl: "/Areas/Admin/HtmlTemplates/Meet/Update.html",
                title: "添加会议",
                callback: function (e) {
                    formInit();//表单初始化
                },
                buttons: [{
                    label: "保存",
                    callback: function (e) {
                        if (!document.forms[0].OngoingTime.value) {
                            $.Nuoya.alert("活动开始时间不能为空");
                            return false;
                        }
                        if (typeof (document.forms[0].OngoingTime.value) == "undefined") {
                            msg = "活动结束时间不能为空";

                        }

                        if (typeof (document.forms[0].OverTime.value) == "undefined") {
                            msg = "活动结束时间不能为空";

                        }
                        if (!document.forms[0].OverTime.value) {
                            $.Nuoya.alert("活动结束时间不能为空");
                            return false;
                        }
                        var ongoingTime = document.forms[0].OngoingTime.value;
                        var overTime = document.forms[0].OverTime.value;
                        if (new Date(ongoingTime) > new Date(overTime)) {
                            $.Nuoya.alert("开始时间必须小于结束时间");
                            return false;
                        }
                        if (!document.forms[0].RoomIDs.value) {
                            $.Nuoya.alert("请选择会议厅");
                            return false;
                        }
                        
                        $("[name=Content]").val(ue.getContent());
                        var result = $.Nuoya.form("form").valid({
                        });
                        if (result) {
                            var data = GetPostObj();
                            if (msg == "") {
                                $.Nuoya.action("/Admin/Meet/Add", data, function (json) {
                                    if (json.Result) {
                                        $.Nuoya.alert("保存成功");
                                        e.hide();
                                        grid.reload();
                                    }
                                    else
                                        $.Nuoya.alert(json.ErrorDesc);
                                });
                            }
                            else {
                                $.Nuoya.alert(msg);
                                return false;
                            }
                        }
                        else {
                            $("#tab1,#tab2").removeClass("am-in").removeClass("am-active");
                            $("#selectTabUl li").removeClass("am-active");
                            if ($("#tab1 .tipso_content").length != 0) {
                                $("#selectTabUl li").eq(0).addClass("am-active");
                                $("#tab1").addClass("am-in").addClass("am-active");
                            }
                            else {
                                $("#selectTabUl li").eq(1).addClass("am-active");
                                $("#tab2").addClass("am-in").addClass("am-active");
                            }
                        }

                    }
                }]
            })
        }
        var msg = "";
        function GetPostObj() {
            msg = ""
            var downLoadInfos = new Array();
            $("#infoFileDiv a").each(function () {
                downLoadInfos.push({
                    Name: $(this).attr("data-Name"),
                    Path: $(this).attr("data-Path"),
                })
            });
            var maxLimit = $("[name='MaxLimit']").val();
            if (maxLimit.trim() == "") {
                msg = "请填写人数限制";
            }
            if (parseInt(maxLimit) < 0)
            {
                msg = "人数限制必须大于等于0";
                return false;
            }
          
            if (ue.getContent().trim() == "") {
                msg = "请填写会议内容";
            }
            var meetPlansAry = new Array();
            $("#roomDiv .meetplan").each(function (index,item) {
                var topicAry = new Array();
                $(this).find(".meetTopic").each(function (pindex,temp) {
                    topicAry.push({
                        ID: $(temp).attr("data-topicId"),
                        RoomID: $(item).attr("data-roomId"),
                        SpeakerID: $(item).find("[name='PlanSpeakerID']").val(),
                        Name: $(temp).find("[name='TopicName']").val(),
                    })
                    if ($(temp).find("[name='TopicName']").val().trim() == "")
                    {
                        msg = "请填写话题名称";
                    }
                });

                if ($(item).find("[name='Name']").val()== "") {
                    msg = "请填写计划名称";
                }
                if (typeof ($(item).find("[name='StratTime']").val()) == "undefined") {
                    msg = "请选择计划开始时间";

                }
                if ($(item).find("[name='StratTime']").val() == "") {
                    msg = "请选择计划开始时间";
                }
                
                meetPlansAry.push({
                    ID: $(item).attr("data-planId"),
                    RoomID: $(item).attr("data-roomId"),
                    StratTime: $(item).find("[name='PlanStartTime']").val(),
                    Name: $(item).find("[name='PlanName']").val(),
                    SpeakerID: $(item).find("[name='PlanSpeakerID']").val(),
                    MeetTopics: topicAry
                })
            });

            if (meetPlansAry.length == 0)
            {
                msg = "请在活动设置里面填写会议计划";
            }
            return data = {
                ID: $("[name='ID']").val(),
                Meet: {
                    Address: $("[name='Address']").val(),
                    Name: $("[name='Name']").val(),
                    OngoingTime: $("[name='OngoingTime']").val(),
                    OverTime: $("[name='OverTime']").val(),
                    PlaceImage: $("[name='PlaceImage']").val(),
                    IsJoinAudit: $("[name='IsJoinAudit']").val(),
                    IsChangeQrcode: $("[name='IsChangeQrcode']").val(),
                    IsAutoAllot: $("[name='IsAutoAllot']").val(),
                    Content: ue.getContent(),
                    RoomIDs: $("[name='RoomIDs']").val(),
                    DownLoadInfos: JSON.stringify(downLoadInfos),
                    MaxLimit:maxLimit
                },
                MeetPlans: meetPlansAry
            };
        }

        //批量删除
        function batchDelete() {
            grid.del({
                ajaxUrl: "/Admin/Meet/Delete",
                callback: function (json) {
                    grid.reload();
                }
            });
        }
        //修改投票数
        function editVoteCount(id, obj)
        {
            var vateCount =parseInt($(obj).prev().val());
            if (vateCount < 0)
            {
                $.Nuoya.alert("投票数不能小于0");
                return false;
            }

            $.Nuoya.action("/Admin/Meet/UpdateCount", { id: id, count: vateCount }, function (json) {
                if (json.Result) {
                    $.Nuoya.alert("修改成功");
                }
                else
                    $.Nuoya.alert(json.ErrorDesc);
            });
        }

        var grid = $.Nuoya.grid({
            tableId: "dataTable",
            //表格id
            search: {
                domainId: "searchDomain",
                subId: "btnSearch"
            },
            ajaxUrl: "/Admin/Meet/GetPageList",
            //数据请求地址
            pageSize: 10,
            events: [
                {
                    className: "am-text-secondary",
                    icon: "icon-pencil-square-o",
                    name: "编辑",
                    click: function (item) {
                        $.Nuoya.ajaxDialog({
                            closeViaDimmer: false,
                            width: ($(window).width() - 100) + "px",
                            height: ($(window).height() - 100) + "px",
                            ajaxUrl: "/Areas/Admin/HtmlTemplates/Meet/Update.html",
                            title: "编辑会议",
                            callback: function (e) {
                                $.Nuoya.action("/admin/Meet/Find", { id: item.ID, isShowRoom:true }, function (model) {
                                    //载入数据
                                    $.Nuoya.form("form").dataLoad({
                                        data: model.Meet
                                    });
                                    $("#loadMeetPlanBtn").hide();
                                    formInit(model);//表单初始化
                                });
                            },
                            buttons: [{
                                label: "保存",
                                callback: function (e) {
                                    if (!document.forms[0].OngoingTime.value) {
                                        $.Nuoya.alert("活动开始时间不能为空");
                                        return false;
                                    }
                                    if (!document.forms[0].OverTime.value) {
                                        $.Nuoya.alert("活动结束时间不能为空");
                                        return false;
                                    }

                                    if (typeof (document.forms[0].OngoingTime.value) == "undefined") {
                                        msg = "活动结束时间不能为空";

                                    }

                                    if (typeof (document.forms[0].OverTime.value) == "undefined") {
                                        msg = "活动结束时间不能为空";

                                    }
                                    var ongoingTime = document.forms[0].OngoingTime.value;
                                    var overTime = document.forms[0].OverTime.value;
                                    if (new Date(ongoingTime) > new Date(overTime)) {
                                        $.Nuoya.alert("开始时间必须小于结束时间");
                                        return false;
                                    }
                                    if (!document.forms[0].RoomIDs.value) {
                                        $.Nuoya.alert("请选择会议厅");
                                        return false;
                                    }
                                    $("[name=Content]").val(ue.getContent());
                                    var result = $.Nuoya.form("form").valid();
                                    var data = GetPostObj();
                                    if (result) {
                                        if (msg == "") {
                                            $.Nuoya.action("/Admin/Meet/Update", data, function (json) {
                                                if (json.Result) {
                                                    $.Nuoya.alert("保存成功");
                                                    e.hide();
                                                    grid.reload();
                                                }
                                                else
                                                    $.Nuoya.alert(json.ErrorDesc);
                                            });
                                        }
                                        else {
                                            $.Nuoya.alert(msg);
                                            return false;
                                        }
                                    }
                                    else {
                                        $("#tab1,#tab2").removeClass("am-in").removeClass("am-active");
                                        $("#selectTabUl li").removeClass("am-active");
                                        if ($("#tab1 .tipso_content").length != 0) {
                                            $("#selectTabUl li").eq(0).addClass("am-active");
                                            $("#tab1").addClass("am-in").addClass("am-active");
                                        }
                                        else {
                                            $("#selectTabUl li").eq(1).addClass("am-active");
                                            $("#tab2").addClass("am-in").addClass("am-active");
                                        }
                                    }
                                }
                            }]
                        })
                    }
                },

               {
                   className: "am-text-success",
                   icon: "icon-usb",
                   name: "报名",
                   //formula: function (item) {
                   //    if (item.IsJoinAudit == 1) {
                   //        return true;
                   //    }
                   //    else {
                   //        return false;
                   //    }
                   //},
                   click: function (item) {
                       window.location.href= "/admin/UserJoin/index?meetId=" + item.ID;
                   }
               },
               {
                   className: "am-text-warning",
                   icon: "icon-universal-access",
                   name: "评论",
                   click: function (item) {
                       window.location.href= "/admin/TopicUserJoin/index?meetId=" + item.ID;
                   }
               },
               {
                   className: "am-text-secondary",
                   icon: "icon-plug",
                   name: "签到",
                   click: function (item) {
                       window.open("/meet/sign?meetId=" + item.ID);
                   }
               },
               {
                   className: "am-text-success",
                   icon: "icon-firefox",
                   name: "预览",
                   click: function (item) {
                       window.open("/home/index?meetId=" + item.ID);
                   }
               },
                //{
                //    className: "am-text-danger",
                //    icon: "icon-trash-o",
                //    name: "删除",
                //    click: function (item) {
                //        $.Nuoya.deleteAction("/admin/Meet/Delete", {
                //            ids: item.ID
                //        },
                //        function (data) {
                //             grid.reload();
                //        });
                //    }
                //},
                {
                    className: "am-text-secondary",
                    icon: "icon-firefox",
                    name: "计划",
                    click: function (item) {
                        window.location.href= "/admin/plan/index?id=" + item.ID;
                    }
                },

                {
                    className: "am-text-success",
                    icon: "icon-user",
                    name: "签到结果",
                    click: function (item) {
                        window.location.href= "/meet/signresult?meetid=" + item.ID;
                    }
                },
                {
                    className: "am-text-secondary",
                    icon: "icon-pie-chart",
                    name: "导入名单",
                    click: function (item) {

                        $.Nuoya.ajaxDialog({
                            closeViaDimmer: false,
                            width: "600px",
                            height: "300px",
                            ajaxUrl: "/Areas/Admin/HtmlTemplates/Meet/SelectFile.html",
                            title: "选择文件",
                            callback: function () {
                            },
                            buttons: [{
                                label: "保存",
                                callback: function (e) {
                                    $.Nuoya.form("form").ajaxSubmit({
                                        ajaxUrl: "/Admin/Meet/ExportInto",
                                        params: {
                                            meetId: item.ID,
                                            mark:'export'
                                        },
                                        callback: function (data) {
                                            if (!data.ErrorDesc) {
                                                $.Nuoya.alert("导入成功");
                                                e.hide();
                                                grid.reload();
                                            }
                                            else
                                                $.Nuoya.alert(data.ErrorDesc);
                                        }
                                    });
                                }
                            }]
                        })
                    }
                },
                {
                    className: "am-text-success",
                    icon: "icon-bluetooth-b",
                    name: "统计",
                    click: function (item) {
                        $.Nuoya.ajaxDialog({
                            closeViaDimmer: false,
                            width: "800px",
                            height: ($(window).height() - 100) + "px",
                            ajaxUrl: "/Areas/Admin/HtmlTemplates/Meet/Report.html",
                            title: "兑奖情况",
                            callback: function (e) {
                                $.Nuoya.action("/admin/Meet/GetReport", { id: item.ID }, function (model) {

                                    $("#exportAllBtn").click(function () {
                                        window.location.href= "/admin/meet/exportAll?id=" + item.ID;
                                    });
                                    $("#exportSignBtn").click(function () {
                                        window.location.href= "/admin/meet/exportSign?id=" + item.ID;
                                    });
                                    $("#joinCount").html("报名参加人数：" + model.JoinCount + "&nbsp;&nbsp;&nbsp;&nbsp;签到人数：" + model.SignCount + "&nbsp;&nbsp;&nbsp;&nbsp;会议计划数：" + model.PlanCount);
                                    $("#topicCount").html("话题数：" + model.TopicCount + "&nbsp;&nbsp;&nbsp;&nbsp;话题参与人数：" + model.TopicJoinCount + "&nbsp;&nbsp;&nbsp;&nbsp;投票参加人数：" + model.VoteCount);
                                    $(model.PlanList).each(function () {
                                        // $("#voteOl").append('<li>&nbsp;&nbsp;&nbsp;&nbsp;<span>' + this.Name + '</span>&nbsp;&nbsp;&nbsp;&nbsp;<span>' + this.Speaker.Name + '</span>&nbsp;&nbsp;&nbsp;&nbsp;投票数：<input type="number" value="' + this.VoteCount + '" min="0" style="width:80px;"/>&nbsp;&nbsp;&nbsp;&nbsp;<a onclick="editVoteCount(\'' + this.ID + '\',this)">修改得票数</a> </li>');
                                        $("#voteOl").append('<li>&nbsp;&nbsp;&nbsp;&nbsp;<span>' + this.Name + '</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>' + this.Speaker.Name + '</span>&nbsp;&nbsp;&nbsp;&nbsp;投票数：' + this.VoteCount + '</li>');
                                    });
                                });
                            },
                        })
                    }
                }
            ]
        });
    </script>


}